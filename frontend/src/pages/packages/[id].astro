---
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const registryUrl = 'https://raw.githubusercontent.com/devkiraa/nex/main/registry/index.json';
  let packages = [];
  
  try {
    if (import.meta.env.DEV) {
      packages = [
        {
          id: 'devkiraa.pagepull',
          name: 'PagePull',
          version: '1.0.0',
          description: 'Extract web pages as clean Markdown for AI/LLM consumption',
          keywords: ['web', 'scraper', 'markdown', 'ai', 'llm'],
          manifest: 'packages/d/devkiraa/pagepull/manifest.json'
        }
      ];
    } else {
      const response = await fetch(registryUrl);
      const data = await response.json();
      packages = data.packages || [];
    }
  } catch (e) {
    packages = [];
  }
  
  return packages.map((pkg: any) => ({
    params: { id: pkg.id },
    props: { pkg }
  }));
}

const { id } = Astro.params;
const pkg = (Astro.props as any).pkg;

const manifestUrl = `https://raw.githubusercontent.com/devkiraa/nex/main/registry/${pkg.manifest}`;
let manifest = null;
let versionHistory: any[] = [];
let dependencyList: any[] = [];

const siteBase = import.meta.env.BASE_URL || '/';

try {
  if (import.meta.env.DEV) {
    manifest = {
      id: pkg.id,
      name: pkg.name,
      version: pkg.version,
      description: pkg.description,
      author: { name: 'DevKira', github: 'devkiraa' },
      license: 'MIT',
      repository: 'https://github.com/devkiraa/pagepull',
      runtime: { type: 'python', version: '>=3.10' },
      entrypoint: 'main.py',
      commands: {
        default: 'python main.py',
        'export': 'python main.py export',
        help: 'python main.py --help'
      },
      keywords: pkg.keywords,
      platforms: ['windows', 'linux', 'macos'],
      dependencies: [
        { id: 'python', version: '>=3.10', type: 'runtime' },
        { id: 'requests', version: '^2.31.0', type: 'library' }
      ],
      versions: [
        { version: '1.0.0', date: '2023-10-25', changelog: 'Initial release.' }
      ]
    };
  } else {
    const response = await fetch(manifestUrl);
    manifest = await response.json();
  }
} catch (e) {
  manifest = pkg;
}

// Version history
const versionsUrl = manifestUrl.replace('manifest.json', 'versions.json');
try {
  const res = await fetch(versionsUrl);
  if (res.ok) {
    versionHistory = await res.json();
  }
} catch (e) {
  versionHistory = manifest.versions || [];
}

if (!versionHistory || versionHistory.length === 0) {
  versionHistory = [
    {
      version: manifest.version,
      date: manifest.publishedAt || manifest.updatedAt || '',
      changelog: manifest.changelog || 'Latest release'
    }
  ];
}

// Dependencies
if (Array.isArray(manifest.dependencies)) {
  dependencyList = manifest.dependencies;
} else if (manifest.dependencies && typeof manifest.dependencies === 'object') {
  dependencyList = Object.entries(manifest.dependencies).map(([dep, ver]) => ({ id: dep, version: ver }));
}
---

<Layout title={`${manifest.name} | nex`} description={manifest.description}>
  <div class="package-header">
    <div class="container">
      <div class="header-top">
        <h1>{manifest.name}</h1>
        <span class="version-tag">v{manifest.version}</span>
        {manifest.license && <span class="license-tag">{manifest.license}</span>}
      </div>
      <p class="package-description">{manifest.description}</p>
      
      <div class="package-tabs">
        <a href="#" class="tab active">Readme</a>
        <a href="#" class="tab">Code</a>
        <a href="#" class="tab">Dependencies</a>
        <a href="#" class="tab">Versions</a>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="package-layout">
      <div class="main-column">
        <div class="readme-content">
          <section class="markdown-section">
            <h2>Usage</h2>
            <div class="code-block">
              <div class="code-header">
                <span>Run this package</span>
                <button class="copy-btn" data-copy={`nex run ${manifest.id}`}>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2"/>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                  </svg>
                </button>
              </div>
              <pre><code>nex run {manifest.id}</code></pre>
            </div>
          </section>

          {manifest.commands && Object.keys(manifest.commands).length > 0 && (
            <section class="markdown-section">
              <h2>Available Commands</h2>
              <div class="commands-table">
                <table>
                  <thead>
                    <tr>
                      <th>Command</th>
                      <th>Runs</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(manifest.commands).map(([name, cmd]) => (
                      <tr>
                        <td><code>nex run {manifest.id} {name}</code></td>
                        <td><code class="cmd-value">{cmd}</code></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          )}

          {manifest.keywords && manifest.keywords.length > 0 && (
            <section class="markdown-section">
              <h2>Keywords</h2>
              <div class="keywords-list">
                {manifest.keywords.map((kw: string) => (
                  <a href="#" class="keyword-tag">{kw}</a>
                ))}
              </div>
            </section>
          )}

          {versionHistory && versionHistory.length > 0 && (
            <section class="markdown-section">
              <h2>Version History</h2>
              <div class="versions-list">
                {versionHistory.map((v) => (
                  <div class="version-item">
                    <div>
                      <div class="version-label">v{v.version}</div>
                      {v.date && <div class="version-date">{v.date}</div>}
                      {v.changelog && <p class="version-notes">{v.changelog}</p>}
                    </div>
                    <div class="version-actions">
                      <button class="copy-btn" data-copy={`nex install ${manifest.id}@${v.version}`} title="Copy install command">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2"/>
                          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}

          {dependencyList && dependencyList.length > 0 && (
            <section class="markdown-section">
              <h2>Dependencies</h2>
              <div class="dependency-graph">
                {dependencyList.map((dep) => (
                  <div class="dependency-node">
                    <div class="dep-line"></div>
                    <div class="dep-card">
                      <div class="dep-name">{dep.id || dep.name}</div>
                      {dep.version && <div class="dep-version">{dep.version}</div>}
                      {dep.type && <span class="dep-tag">{dep.type}</span>}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}
        </div>
      </div>

      <aside class="sidebar-column">
        <div class="sidebar-block">
          <h3>Install</h3>
          <div class="install-cmd-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="cmd-icon">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
            </svg>
            <code>nex install {manifest.id}</code>
            <button class="copy-icon-btn" data-copy={`nex install ${manifest.id}`} title="Copy to clipboard">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="sidebar-block">
          <h3>Repository</h3>
          {manifest.repository ? (
            <a href={manifest.repository} target="_blank" rel="noopener" class="sidebar-link">
              <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
              </svg>
              <span>{manifest.repository.replace('https://github.com/', '')}</span>
            </a>
          ) : (
            <span class="sidebar-text">No repository linked</span>
          )}
        </div>

        <div class="sidebar-block">
          <h3>Details</h3>
          <div class="sidebar-info">
            {manifest.author && (
              <div class="info-item">
                <span class="label">Author</span>
                <span class="value">
                  {typeof manifest.author === 'string' ? manifest.author : (
                    manifest.author.github ? (
                      <a href={`https://github.com/${manifest.author.github}`} target="_blank" rel="noopener">
                        {manifest.author.name || manifest.author.github}
                      </a>
                    ) : manifest.author.name
                  )}
                </span>
              </div>
            )}
            
            <div class="info-item">
              <span class="label">Version</span>
              <span class="value">{manifest.version}</span>
            </div>

            {manifest.license && (
              <div class="info-item">
                <span class="label">License</span>
                <span class="value">{manifest.license}</span>
              </div>
            )}

            {manifest.runtime && (
              <div class="info-item">
                <span class="label">Runtime</span>
                <span class="value">{manifest.runtime.type} {manifest.runtime.version}</span>
              </div>
            )}
          </div>
        </div>

        {manifest.platforms && (
          <div class="sidebar-block">
            <h3>Platforms</h3>
            <div class="platforms-list">
              {manifest.platforms.map((p: string) => (
                <span class="platform-tag">{p}</span>
              ))}
            </div>
          </div>
        )}
      </aside>
    </div>
  </main>
</Layout>

<style>
  :root {
    --header-bg: #ffffff;
    --border-color: #e1e4e8;
    --text-primary: #24292e;
    --text-secondary: #586069;
    --link-color: #0366d6;
    --bg-gray: #f6f8fa;
  }

  .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* Header Styles */
  .package-header {
    background: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    padding-top: 2rem;
  }

  .header-top {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .header-top h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .version-tag {
    color: var(--text-secondary);
    font-size: 1rem;
    font-family: var(--font-mono);
  }

  .license-tag {
    font-size: 0.8rem;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2px 10px;
    color: var(--text-secondary);
  }

  .package-description {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    max-width: 800px;
  }

  .package-tabs {
    display: flex;
    gap: 2rem;
  }

  .tab {
    text-decoration: none;
    color: var(--text-secondary);
    padding: 0.75rem 0.5rem;
    font-size: 0.95rem;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
  }

  .tab:hover {
    color: var(--text-primary);
  }

  .tab.active {
    color: var(--text-primary);
    border-bottom-color: #cb3837;
    font-weight: 500;
  }

  /* Main Layout */
  .package-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 350px;
    gap: 3rem;
    padding: 2rem 0;
  }

  .main-column,
  .sidebar-column {
    min-width: 0;
  }

  /* Main Content */
  .markdown-section {
    margin-bottom: 2.5rem;
  }

  .markdown-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .code-block {
    background: #1e1e1e;
    border-radius: 6px;
    border: 1px solid #333;
  }

  .code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #333;
    background: #252526;
    border-radius: 6px 6px 0 0;
  }

  .code-header span {
    font-size: 0.85rem;
    color: #cccccc;
    font-weight: 500;
  }

  .copy-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    border: 1px solid var(--border-color);
    background: #ffffff;
    color: var(--text-primary);
    border-radius: 8px;
    padding: 0.4rem 0.6rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    line-height: 1;
    white-space: nowrap;
  }

  .copy-btn:hover {
    background: #f6f8fa;
    border-color: #cb3837;
  }

  .copy-btn.copied {
    background: #fff5f5;
    border-color: #cb3837;
    color: #cb3837;
  }

  .copy-btn svg {
    width: 16px;
    height: 16px;
  }

  .code-block pre {
    margin: 0;
    padding: 1rem;
    overflow-x: auto;
    background-color: transparent;
    color: #ffffff;
  }

  .code-block code {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: #ffffff;
  }

  /* Commands Table */
  .commands-table {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
  }

  .commands-table table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .commands-table th,
  .commands-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    overflow-wrap: anywhere;
    word-break: break-word;
  }

  .commands-table th {
    background: #f6f8fa;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .commands-table tr:last-child td {
    border-bottom: none;
  }

  .cmd-value {
    background: #1e1e1e;
    color: #ffffff;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
  }

  /* Keywords */
  .keywords-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .keyword-tag {
    text-decoration: none;
    color: #cb3837;
    background: #fff0f0;
    padding: 0.3rem 0.8rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: background 0.2s;
  }

  .keyword-tag:hover {
    background: #ffe0e0;
  }

  /* Versions */
  .versions-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .version-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: #fff;
  }

  .version-label {
    font-weight: 700;
    color: var(--text-primary);
  }

  .version-date {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .version-notes {
    margin: 0.35rem 0 0;
    color: var(--text-secondary);
  }

  .version-actions .copy-btn {
    padding: 0.4rem 0.5rem;
  }

  /* Dependency graph */
  .dependency-graph {
    display: grid;
    gap: 0.75rem;
  }

  .dependency-node {
    display: grid;
    grid-template-columns: 14px 1fr;
    align-items: center;
    gap: 0.75rem;
  }

  .dep-line {
    width: 2px;
    height: 100%;
    background: var(--border-color);
    margin-left: 6px;
  }

  .dep-card {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    background: #f9f9f9;
  }

  .dep-name {
    font-weight: 700;
    color: var(--text-primary);
  }

  .dep-version {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .dep-tag {
    display: inline-block;
    margin-top: 0.35rem;
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    background: #fff5f5;
    color: #cb3837;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* Badges */
  .badge-grid {
    display: grid;
    grid-template-columns: minmax(0, 220px) minmax(0, 1fr);
    gap: 1.25rem;
    align-items: start;
  }

  .badge-preview {
    padding: 1rem;
    background: #f6f8fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .badge-preview img {
    max-width: 100%;
    height: auto;
  }

  .badge-snippets pre {
    margin: 0;
    max-width: 100%;
    overflow-x: auto;
    padding: 0.85rem 1rem;
    border-radius: 10px;
    border: 1px solid #333;
    background: #1e1e1e;
    color: #ffffff;
  }

  .badge-snippets code {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    white-space: pre;
  }

  .badge-snippets {
    display: grid;
    gap: 1rem;
    min-width: 0;
  }

  .snippet-block {
    display: grid;
    gap: 0.6rem;
  }

  .snippet-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .snippet-label {
    font-weight: 600;
    color: var(--text-secondary);
  }

  /* Charts */
  .chart-box {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #333;
  }

  .chart-box canvas {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
  }

  .muted {
    color: var(--text-secondary);
  }

  /* Sidebar */
  .sidebar-block {
    margin-bottom: 2rem;
  }

  .sidebar-block h3 {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  .install-cmd-box {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #1e1e1e;
    border: 1px solid #333;
    padding: 0.75rem;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: #ffffff;
  }

  .install-cmd-box code {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .cmd-icon {
    width: 16px;
    height: 16px;
    color: var(--text-secondary);
  }

  .copy-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .copy-icon-btn:hover {
    background: #f0f0f0;
    color: var(--text-primary);
  }

  .copy-icon-btn svg {
    width: 16px;
    height: 16px;
  }

  .sidebar-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.95rem;
  }

  .sidebar-link:hover {
    color: #cb3837;
    text-decoration: underline;
  }

  .sidebar-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .info-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 0.9rem;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }

  .info-item:last-child {
    border-bottom: none;
  }

  .info-item .label {
    color: var(--text-secondary);
    font-weight: 500;
  }

  .info-item .value {
    color: var(--text-primary);
    font-weight: 600;
    text-align: right;
  }

  .info-item a {
    color: var(--text-primary);
    text-decoration: none;
  }

  .info-item a:hover {
    text-decoration: underline;
  }

  .platforms-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .platform-tag {
    font-size: 0.8rem;
    padding: 2px 8px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .badge-grid {
      grid-template-columns: 1fr;
    }

    .dependency-node {
      grid-template-columns: 10px 1fr;
    }

    .version-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .package-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
      padding: 1.5rem 0;
    }
    
    .sidebar-column {
      order: -1;
    }
    
    .header-top {
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .header-top h1 {
      font-size: 1.35rem;
      width: 100%;
    }
    
    .package-tabs {
      gap: 1rem;
      flex-wrap: wrap;
      overflow-x: visible;
      padding-bottom: 0;
    }
    
    .tab {
      white-space: nowrap;
      font-size: 0.9rem;
      padding: 0.5rem 0.25rem;
    }
    
    .markdown-section h2 {
      font-size: 1.25rem;
    }
    
    .commands-table {
      overflow: hidden;
    }
    
    .commands-table table {
      min-width: 0;
    }
    
    .commands-table th,
    .commands-table td {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }
  }
  
  @media (max-width: 480px) {
    .container {
      padding: 0 0.75rem;
    }
    
    .package-header {
      padding-top: 1.25rem;
    }
    
    .header-top h1 {
      font-size: 1.2rem;
    }
    
    .version-tag {
      font-size: 0.85rem;
    }
    
    .license-tag {
      font-size: 0.7rem;
      padding: 2px 8px;
    }
    
    .package-description {
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }
    
    .code-block pre {
      padding: 0.75rem;
      font-size: 0.8rem;
    }
    
    .code-header {
      padding: 0.4rem 0.75rem;
    }
    
    .code-header span {
      font-size: 0.75rem;
    }
    
    .install-cmd-box {
      padding: 0.6rem;
      font-size: 0.75rem;
    }
    
    .install-cmd-box code {
      word-break: break-all;
      white-space: normal;
    }
    
    .sidebar-block h3 {
      font-size: 0.75rem;
    }
    
    .info-item {
      font-size: 0.85rem;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .info-item .value {
      text-align: left;
    }
    
    .sidebar-link {
      font-size: 0.9rem;
      word-break: break-all;
    }
    
    .keyword-tag {
      font-size: 0.8rem;
      padding: 0.25rem 0.6rem;
    }
    
    .copy-btn svg,
    .copy-icon-btn svg {
      width: 14px;
      height: 14px;
    }
  }
</style>

<script>
  const copyToClipboard = async (btn: HTMLElement) => {
    const text = btn.dataset.copy;
    if (text) {
      try {
        await navigator.clipboard.writeText(text);
        const svg = btn.querySelector('svg');
        const original = svg ? svg.innerHTML : null;
        const originalText = btn.textContent;

        if (svg) {
          svg.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
        } else {
          btn.textContent = 'Copied!';
        }

        btn.classList.add('copied');
        setTimeout(() => {
          if (svg && original !== null) svg.innerHTML = original;
          if (!svg && originalText) btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 1500);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }
  };

  document.querySelectorAll('.copy-btn, .copy-icon-btn').forEach(btn => {
    btn.addEventListener('click', () => copyToClipboard(btn as HTMLElement));
  });

  // Simple canvas bar chart for downloads
  const chartEl = document.getElementById('download-chart') as HTMLCanvasElement;
  if (chartEl) {
    const ctx = chartEl.getContext('2d');
    const series = JSON.parse(chartEl.dataset.series || '[]');
    if (ctx && series.length) {
      const padding = 32;
      const width = chartEl.width - padding * 2;
      const height = chartEl.height - padding * 2;
      const max = Math.max(...series.map((s: any) => s.count));
      const barWidth = width / series.length - 12;

      ctx.clearRect(0, 0, chartEl.width, chartEl.height);
      ctx.fillStyle = '#0f0f0f';
      ctx.fillRect(0, 0, chartEl.width, chartEl.height);

      series.forEach((s: any, idx: number) => {
        const x = padding + idx * (barWidth + 12);
        const barHeight = max ? (s.count / max) * height : 0;
        const y = chartEl.height - padding - barHeight;
        ctx.fillStyle = '#cb3837';
        ctx.fillRect(x, y, barWidth, barHeight);
        ctx.fillStyle = '#ccc';
        ctx.font = '10px monospace';
        ctx.fillText(s.date || '', x, chartEl.height - padding + 12);
      });
    }
  }
</script>
